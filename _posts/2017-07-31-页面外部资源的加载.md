---
layout: post
title:  "网页外部资源的加载"
date:   2017-07-31 10:40:50 +0800
categories: Web
---

一张页面会指向各种各样的外部资源（图片、样式表、js 文件），具体的顺序是如何的呢？

## 脚本

浏览器默认的脚本加载模型是同步的，这意味着，当浏览器解析到一个 `<script>` 标签时，浏览器会立马执行该标签的内容。如果该标签指向一个需要通过网络加载的外部资源，那么浏览器会先下载该资源，再执行。在这个过程中，浏览器会停止 html 的解析。

你可以给 `<script>` 标签添加不同的属性来调整上面的过程：

- `defer`：脚本将在文档（document）解析完之后再执行（下载和解析是并行的），注意：defer 脚本的执行时间点在 `DOMContentLoaded` 事件触发之前。
- `async`：HTML5 加入的新属性，标记该标签的执行方式为异步执行，注意：该属性必须与 `src` 属性同时使用

上面两个属性的差别在于：

> Both async and defer scripts begin to download immediately without pausing the parser and both support an optional onload handler to address the common need to perform initialization which depends on the script. The difference between async and defer centers around when the script is executed. Each async script executes at the first opportunity after it is finished downloading and before the window's load event. This means it's possible (and likely) that async scripts are not executed in the order in which they occur in the page. The defer scripts, on the other hand, are guaranteed to be executed in the order they occur in the page. That execution starts after parsing is completely finished, but before the document's DOMContentLoaded event.

### 预测性解析

对于上面脚本的加载，WebKit 和 Firefox 都做了优化：在执行某脚本的过程中，另一个线程会继续解析文档，找出不会修改 DOM 树的外部资源进行加载，比如外部脚本、样式表和图片。

## 样式表

样式表的加载模型与脚本不同。按理来说，因为样式表不会修改 DOM，所以加载样式表应该不会阻塞文档的解析。但是文档的解析过程中，面对未知的样式表加载状态，使用脚本去拿当前的样式信息成为一件不靠谱的事。面对这个问题，不同的浏览器处理方式不同。Firefox 会在加载样式表时停止所有脚本的执行，而 WebKit 只会停止访问样式表信息的脚本。