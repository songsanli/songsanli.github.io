---
layout: post
title:  "网页外部资源的加载"
date:   2017-07-31 10:40:50 +0800
categories: Web
---

一张页面会引用各种各样的外部资源（图片、样式表、js 文件），具体的加载是怎么的呢？

## 脚本

浏览器默认的脚本加载模型是同步的，这意味着，当浏览器解析到一个 `<script>` 标签时，浏览器会立马执行该标签的内容。如果该标签指向一个需要通过网络加载的外部资源，那么浏览器会先下载该资源，再执行。在这个过程中，浏览器会停止 html 的解析。

你可以给 `<script>` 标签添加不同的属性来调整上面的过程：

- `defer`：脚本将在文档（document）解析完之后再执行（下载和解析是并行的），注意：defer 脚本的执行时间点在 `DOMContentLoaded` 事件触发之前。
- `async`：HTML5 加入的新属性，标记该标签的执行方式为异步执行，注意：该属性必须与 `src` 属性同时使用

上面两个属性的异同在于：

- 解析器遇到带有 `async` 和 `defer` 属性的脚本后都会立马开始下载该脚本，然后继续解析文档；这两个属性都支持一个 optional 的 `onload` 事件方便你在该脚本加载完后立马做点事情
- 它们主要的不同在于脚本的执行时间点不同：异步脚本会在它被下载完后的第一时间执行，这个时间点在浏览器的 load 事件之前，这样的模型意味多个异步脚本的执行顺序和它们在文档中的定义顺序不一定相同；而延迟脚本是在解析结束后、DOMContentLoaded 事件前执行，而且可以保证是按定义顺序执行

### 预测性解析

对于上面脚本的加载，WebKit 和 Firefox 都做了优化：在执行某脚本的过程中，另一个线程会继续解析文档，找出不会修改 DOM 树的外部资源进行加载，比如外部脚本、样式表和图片。

## 样式表

样式表的加载模型与脚本不同。按理来说，因为样式表不会修改 DOM，所以加载样式表应该不会阻塞文档的解析。但是文档的解析过程中，面对未知的样式表加载状态，使用脚本去拿当前的样式信息成为一件不靠谱的事。面对这个问题，不同的浏览器处理方式不同。Firefox 会在加载样式表时停止所有脚本的执行，而 WebKit 只会停止访问样式表信息的脚本。